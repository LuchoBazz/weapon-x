# Weapon-X Frontend — Architecture Reference

> **AI-Agent & Developer Knowledge Base (CLAUDE.md compatible)**
>
> This document defines every pattern, convention, and constraint that governs the frontend codebase. All future code generation MUST conform to these rules.

---

## Table of Contents

1. [Architectural Overview](#architectural-overview)
2. [System Integration Map](#system-integration-map)
3. [Directory Structure](#directory-structure)
4. [Tech Stack](#tech-stack)
5. [Styling Strategy](#styling-strategy)
6. [State Management & Data Flow](#state-management--data-flow)
7. [Coding Standards](#coding-standards)
8. [Do's and Don'ts](#dos-and-donts)

---

## Architectural Overview

The frontend follows a **Service-Oriented Component Architecture**:

```
Pages (routes)
  │
  ▼
Dashboard Components     ← Feature-specific UI (ConfigList, Editor, Simulator)
  │
  ▼
UI Primitives            ← Shadcn/Radix components (Button, Select, Dialog…)
  │
  ▼
Services                 ← Business logic layer (config.service.ts)
  │
  ▼
SDK (packages/sdk)       ← HTTP clients for backend API
  │
  ▼
Backend API (server/)    ← Express + Prisma + PostgreSQL
```

### Key Principles

- **Pages** orchestrate layout and state, delegate to feature components.
- **Feature components** (`src/components/dashboard/`) own domain-specific UI and call services.
- **Services** (`src/services/`) encapsulate all data operations (local + remote).
- **UI primitives** (`src/components/ui/`) are pure, reusable, domain-agnostic Shadcn components.
- **Hooks** (`src/hooks/`) provide cross-cutting concerns (theme, environment, toast).

---

## System Integration Map

```
┌─────────────────────────────────────────────────────────┐
│                   Frontend (Vite + React)                │
│                                                         │
│  Pages ──► Components ──► Services ──► SDK Clients      │
│                                           │             │
│  Environment Context ─────────────────────┤             │
│  (base URL, API key per region)           │             │
│                                           ▼             │
│                                    AdminClient          │
│                                    EvaluationClient     │
│                                    SyncEvaluationClient │
└───────────────────────────────────────────┬─────────────┘
                                            │ HTTP (axios)
                                            ▼
┌─────────────────────────────────────────────────────────┐
│              Backend API (Express)                       │
│  /v1/admin/configs    ← CRUD management                 │
│  /v1/evaluate         ← Flag resolution                 │
└─────────────────────────────────────────────────────────┘
```

### Dual Execution Mode

Controlled by `VITE_ENABLE_SDK_INTEGRATION`:

| Value     | Behavior                                                  |
|-----------|-----------------------------------------------------------|
| `'true'`  | SDK clients make real HTTP calls to the backend API       |
| _other_   | Falls back to localStorage persistence (offline-capable)  |

The fallback is transparent — services try SDK first, catch errors, and degrade to local storage.

---

## Directory Structure

```
src/
├── pages/
│   ├── Index.tsx              # Main dashboard page (route: /)
│   ├── NotFound.tsx           # 404 catch-all
│   └── [NewPage].tsx          # ← Add new pages here
│
├── components/
│   ├── dashboard/             # Feature components (domain-specific)
│   │   ├── Sidebar.tsx        # Navigation + environment selector
│   │   ├── ConfigList.tsx     # Configuration table with filters
│   │   ├── Editor.tsx         # Config create/edit form + rule builder
│   │   ├── Simulator.tsx      # Evaluation testing UI
│   │   ├── EnvironmentSelector.tsx  # Region switcher dropdown
│   │   ├── StatusBadge.tsx    # Active/inactive indicator
│   │   └── ToggleSwitch.tsx   # Boolean toggle control
│   ├── auth/
│   │   └── LoginForm.tsx      # Authentication page
│   └── ui/                    # ⚠️ DO NOT EDIT — Shadcn primitives
│       ├── button.tsx
│       ├── select.tsx
│       ├── dialog.tsx
│       └── ...                # Auto-generated by shadcn CLI
│
├── hooks/
│   ├── use-theme.ts           # Dark/light mode with localStorage + system pref
│   ├── use-environment.tsx    # Environment context provider + hook
│   ├── use-toast.ts           # Toast notification hook
│   └── use-mobile.tsx         # Responsive breakpoint detection
│
├── services/
│   └── config.service.ts      # Config CRUD + evaluation (SDK ↔ localStorage)
│
├── lib/
│   ├── types.ts               # Shared TypeScript interfaces (Config, Rule, etc.)
│   ├── constants.ts           # Project refs, operators, ID generator
│   ├── environments.ts        # Environment definitions (regions, URLs, keys)
│   ├── sdk.ts                 # SDK client factory (environment-aware singletons)
│   ├── evaluation.ts          # Local evaluation logic (condition matching)
│   ├── initial-data.ts        # Seed data for localStorage mode
│   └── utils.ts               # cn() utility for Tailwind class merging
│
├── index.css                  # CSS variables (design tokens) + Tailwind directives
└── main.tsx                   # App entry point
```

### Where to Put New Code

| What                          | Where                                     |
|-------------------------------|-------------------------------------------|
| New route/page                | `src/pages/NewPage.tsx` + route in App.tsx |
| Feature-specific component    | `src/components/dashboard/`               |
| Reusable UI primitive         | `npx shadcn-ui add <component>`           |
| Cross-cutting hook            | `src/hooks/use-<name>.ts`                 |
| Data operation / API call     | `src/services/<domain>.service.ts`        |
| Shared type/interface         | `src/lib/types.ts`                        |
| New design token              | `src/index.css` (:root / .dark)           |
| New Tailwind color alias      | `tailwind.config.ts` → extend.colors      |

---

## Tech Stack

| Technology           | Version  | Role                                           |
|----------------------|----------|-------------------------------------------------|
| **React**            | 18.x     | UI library (functional components only)         |
| **TypeScript**       | 5.x      | Type safety everywhere                          |
| **Vite**             | 5.x      | Build tool, dev server, HMR                     |
| **Tailwind CSS**     | 3.x      | Utility-first styling                           |
| **Shadcn UI**        | latest   | Radix-based component primitives                |
| **React Router**     | 6.x      | Client-side routing                             |
| **TanStack Query**   | 5.x      | Async state (available, used for provider only) |
| **Lucide React**     | 0.462    | Icon library (tree-shakable)                    |
| **Axios**            | 1.x      | HTTP client (via SDK)                           |
| **Vitest**           | latest   | Unit testing                                    |

---

## Styling Strategy

### Design Token System

All colors are defined as **HSL CSS variables** in `src/index.css` and consumed via `tailwind.config.ts`:

```
index.css (HSL values)  →  tailwind.config.ts (hsl() wrappers)  →  Components (semantic classes)
```

**Critical rule:** NEVER use raw color values (`text-white`, `bg-blue-500`, `#ff0000`) in components. Always use semantic tokens:

```tsx
// ✅ Correct
<div className="bg-background text-foreground border-border" />
<div className="bg-sidebar text-sidebar-fg" />
<div className="bg-badge-green-bg text-badge-green-fg" />

// ❌ Wrong
<div className="bg-white text-black border-gray-200" />
<div className="bg-[#1a1f2e] text-[#cbd5e1]" />
```

### Available Token Families

| Family       | Tokens                                                        |
|--------------|---------------------------------------------------------------|
| **Core**     | `background`, `foreground`, `card`, `popover`, `muted`        |
| **Brand**    | `primary`, `secondary`, `accent`, `destructive`               |
| **Sidebar**  | `sidebar`, `sidebar-hover`, `sidebar-active`, `sidebar-fg`    |
| **Badges**   | `badge-{blue,green,yellow,red,purple,gray}-{bg,fg,border}`    |
| **Surface**  | `surface-raised`, `surface-code`                              |
| **Controls** | `toggle-active`, `toggle-inactive`, `rule-accent`             |

### Theming

- Dark/light mode via `.dark` class on `<html>` (Tailwind `darkMode: ["class"]`).
- `useTheme()` hook manages toggle + localStorage persistence + system preference fallback.
- Both `:root` and `.dark` blocks in `index.css` must define ALL tokens.

### Responsiveness

- Mobile detection via `useMobile()` hook (breakpoint-based).
- Use Tailwind responsive prefixes: `sm:`, `md:`, `lg:`, `xl:`.
- Sidebar is fixed-width (w-64); main content is `flex-1 overflow-auto`.

---

## State Management & Data Flow

### State Architecture

```
┌─────────────────────────────────────────────┐
│ React Context (global)                      │
│  • EnvironmentProvider (region, API config)  │
│  • QueryClientProvider (TanStack Query)      │
│  • TooltipProvider (Radix)                   │
├─────────────────────────────────────────────┤
│ Page-level state (useState)                 │
│  • configs[], selectedProject, view, filters │
├─────────────────────────────────────────────┤
│ Component-local state                       │
│  • Form inputs, UI toggles, transient state  │
└─────────────────────────────────────────────┘
```

### Data Flow Pattern

1. **Page** calls service functions (`getInitialConfigs`, `createConfig`, etc.).
2. **Service** checks `SDK_ENABLED`:
   - `true` → calls `AdminClient` / `EvaluationClient` (HTTP to backend).
   - `false` or error → falls back to `localStorage`.
3. **Service** returns updated data; page updates state via `setConfigs(...)`.
4. **Environment switch** triggers `resetClients()` → SDK singletons are recreated with new base URL + credentials → page resets and re-fetches.

### SDK Client Lifecycle

```typescript
// Singletons are lazily created and cached per environment
getAdminClient()      → checks current env → creates/reuses AdminClient
getEvaluationClient() → checks current env → creates/reuses EvaluationClient
resetClients()        → nullifies cache (called on environment switch)
```

### Adding New Data Operations

1. Add method to the appropriate service in `src/services/`.
2. Follow the SDK-first-with-fallback pattern:
```typescript
export async function myOperation(args): Promise<Result> {
  if (SDK_ENABLED) {
    try {
      const client = getAdminClient();
      return await client.myMethod(args);
    } catch (err) {
      console.error('[SDK] myOperation failed, falling back:', err);
    }
  }
  // localStorage fallback
  return localImplementation(args);
}
```

---

## Coding Standards

### Component Conventions

```typescript
// File: src/components/dashboard/MyComponent.tsx

import React from 'react';                          // React import
import { SomeIcon } from 'lucide-react';            // Icons
import { Button } from '@/components/ui/button';     // UI primitives
import { useEnvironment } from '@/hooks/use-environment'; // Hooks
import { Config } from '@/lib/types';                // Types

interface MyComponentProps {
  config: Config;
  onSave: (config: Config) => void;
}

const MyComponent: React.FC<MyComponentProps> = ({ config, onSave }) => {
  // hooks first, then derived state, then handlers, then render
  return <div className="bg-card text-card-foreground rounded-lg p-4">...</div>;
};

export default MyComponent;
```

### Naming Conventions

| Entity              | Convention                  | Example                          |
|---------------------|-----------------------------|----------------------------------|
| Component file      | PascalCase.tsx              | `ConfigList.tsx`                 |
| Hook file           | use-kebab-case.ts           | `use-theme.ts`                   |
| Service file        | kebab-case.service.ts       | `config.service.ts`              |
| Type/Interface      | PascalCase                  | `Config`, `EvaluationResult`     |
| CSS variable        | --kebab-case                | `--sidebar-bg`                   |
| Tailwind token      | kebab-case                  | `bg-sidebar-hover`               |
| Constants           | UPPER_SNAKE_CASE            | `PROJECT_REFS`, `OPS`            |
| Event handlers      | handle + Action             | `handleSaveConfig`               |
| Boolean props       | is/has/should prefix        | `isActive`, `hasRules`           |

### Import Order

```typescript
// 1. React
import React, { useState, useMemo } from 'react';
// 2. Third-party libraries
import { useNavigate } from 'react-router-dom';
// 3. Icons
import { Plus, Trash2 } from 'lucide-react';
// 4. UI primitives (@/components/ui/)
import { Button } from '@/components/ui/button';
// 5. Feature components (@/components/)
import Sidebar from '@/components/dashboard/Sidebar';
// 6. Hooks
import { useEnvironment } from '@/hooks/use-environment';
// 7. Services
import { createConfig } from '@/services/config.service';
// 8. Types & constants
import { Config } from '@/lib/types';
```

### Custom Hook Rules

- File name: `use-<name>.ts` (or `.tsx` if it provides a Provider).
- Must start with `use` prefix.
- Must handle cleanup in `useEffect` return.
- Must be placed in `src/hooks/`.
- Context hooks must throw if used outside their Provider.

```typescript
// Pattern for context-based hooks
export function useMyContext() {
  const ctx = useContext(MyContext);
  if (!ctx) throw new Error('useMyContext must be used within MyProvider');
  return ctx;
}
```

---

## Do's and Don'ts

### ✅ DO

- Use semantic Tailwind tokens (`bg-background`, `text-muted-foreground`) for ALL colors.
- Define new colors in BOTH `:root` and `.dark` blocks in `index.css`.
- Register new colors in `tailwind.config.ts` → `extend.colors`.
- Use `@/` path alias for all imports.
- Keep components under 200 lines; extract sub-components when exceeded.
- Use `React.FC<Props>` with explicit interface for all components.
- Use Shadcn primitives from `src/components/ui/` for all standard UI elements.
- Follow SDK-first-with-fallback pattern in services.
- Use `cn()` from `@/lib/utils` for conditional class merging.
- Persist user preferences in `localStorage` (theme, environment, etc.).

### ❌ DON'T

- **Never** use raw colors: `text-white`, `bg-black`, `bg-blue-500`, `#hex`, `rgb()`.
- **Never** edit files in `src/components/ui/` — they are Shadcn-managed.
- **Never** import from relative paths when `@/` alias is available.
- **Never** store API keys or secrets in client-side code.
- **Never** call SDK clients directly from components — go through services.
- **Never** use `any` type — use `unknown` and narrow, or define proper types.
- **Never** use `useEffect` for derived state — use `useMemo` instead.
- **Never** mix business logic into UI components — extract to services or hooks.
- **Never** create a new CSS file — all custom styles go in `index.css`.
- **Never** skip the fallback branch when adding SDK-dependent features.

### ⚠️ Constraints

- Rule `return_value` max length: **32,768 characters** (enforced across the stack).
- Config types are strictly: `BOOLEAN`, `JSON`, `STRING`, `SECRET`.
- Condition operators: `EQUALS`, `NOT_EQUALS`, `IN`, `NOT_IN`, `CONTAINS`, `GREATER_THAN`, `LESS_THAN`, `REGEX`.
- Rollout percentage: integer 0–100, deterministic via SHA-256 hash.
- Environment switching resets ALL client state and SDK connections.
